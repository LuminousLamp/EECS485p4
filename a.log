============================= test session starts ==============================
platform darwin -- Python 3.11.0, pytest-8.1.1, pluggy-1.4.0 -- /Users/led/Documents/EECS485p4/485p4/bin/python3.11
cachedir: .pytest_cache
rootdir: /Users/led/Documents/EECS485p4
configfile: pyproject.toml
plugins: mock-3.12.0
collecting ... collected 1 item

tests/test_manager_03.py::test_finish 
-------------------------------- live log call ---------------------------------
INFO     mapreduce.manager.__main__:__main__.py:26 Manager init: host=localhost port=6000 pwd=/Users/led/Documents/EECS485p4
INFO     mapreduce.manager.__main__:__main__.py:61 manager setup TCP
INFO     mapreduce.manager.__main__:__main__.py:391 Manager setup UDP
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type register
INFO     mapreduce.manager.__main__:__main__.py:137 register worker ('localhost', 3001)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type new_manager_job
INFO     mapreduce.manager.__main__:__main__.py:164 creating a new job 0
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:244 starting to run a job: 0
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:254 Created tmpdir /private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 0 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 1 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:310 ----------fddd----------
INFO     mapreduce.manager.__main__:__main__.py:327 manager going to assign reduce task 0, with 2 input files
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 0 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type shutdown
INFO     mapreduce.manager.__main__:__main__.py:113 call shutdown on manager, now there is 1 workers
INFO     mapreduce.manager.__main__:__main__.py:413 worker 3001 receices heartbeat
FAILED

=================================== FAILURES ===================================
_________________________________ test_finish __________________________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x1024c3350>
tmp_path = PosixPath('/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0')

    def test_finish(mocker, tmp_path):
        """Verify Manager finishes job correctly.
    
        Note: 'mocker' is a fixture function provided the the pytest-mock package.
        This fixture lets us override a library function with a temporary fake
        function that returns a hardcoded value while testing.
    
        See https://github.com/pytest-dev/pytest-mock/ for more info.
    
        Note: 'tmp_path' is a fixture provided by the pytest-mock package.
        This fixture creates a temporary directory for use within this test.
    
        See https://docs.pytest.org/en/6.2.x/tmpdir.html for more info.
        """
        # Mock the socket library socket class
        mock_socket = mocker.patch("socket.socket")
    
        # sendall() records messages
        mock_sendall = mock_socket.return_value.__enter__.return_value.sendall
    
        # connect() records message destinations
        mock_connect = mock_socket.return_value.__enter__.return_value.connect
    
        # accept() returns a mock client socket
        mock_clientsocket = mocker.MagicMock()
        mock_accept = mock_socket.return_value.__enter__.return_value.accept
        mock_accept.return_value = (mock_clientsocket, ("127.0.0.1", 10000))
    
        # TCP recv() returns values generated by worker_message_generator()
        mock_recv = mock_clientsocket.recv
        mock_recv.side_effect = worker_message_generator(mock_sendall, tmp_path)
    
        # UDP recv() returns heartbeat messages
        mock_udp_recv = mock_socket.return_value.__enter__.return_value.recv
        mock_udp_recv.side_effect = utils.worker_heartbeat_generator(3001)
    
        # Set the location where the Manager's temporary directory
        # will be created.
        tempfile.tempdir = tmp_path
    
        # Spy on tempfile.TemporaryDirectory so that we can determine the name
        # of the directory that was created.
        mock_tmpdir = mocker.spy(tempfile.TemporaryDirectory, "__init__")
    
        # Run student Manager code.  When student Manager calls recv(), it will
        # return the faked responses configured above.
        try:
            mapreduce.manager.Manager("localhost", 6000)
            assert threading.active_count() == 1, "Failed to shutdown threads"
        except SystemExit as error:
            assert error.code == 0
    
        # Verify that the correct number of TemporaryDirectories was used.
        assert mock_tmpdir.call_count == 1, \
            "Expected to see call to `tempfile.TemporaryDirectory(...)`"
    
        # Find the name of the temporary directory.
        tmpdir_job0 = utils.get_tmpdir_name(mock_tmpdir)
    
        # Verify messages sent by the Manager
        #
        # `messages` is a list of tuples, where each tuple contains a message and
        # the destination of the message.
        #
        # Pro-tip: show log messages and detailed diffs with
        #   $ pytest -vvs --log-cli-level=info tests/test_manager_X.py
        messages = utils.get_messages_with_destinations(mock_sendall, mock_connect)
    
>       assert messages == [
            (
                {
                    "message_type": "register_ack",
                },
                {
                    "destination": ("localhost", 3001),
                },
            ),
            (
                {
                    "message_type": "new_map_task",
                    "task_id": 0,
                    "executable": str(TESTDATA_DIR/"exec/wc_map.sh"),
                    "input_paths": [
                        str(TESTDATA_DIR/"input/file01"),
                        str(TESTDATA_DIR/"input/file03"),
                        str(TESTDATA_DIR/"input/file05"),
                        str(TESTDATA_DIR/"input/file07"),
                    ],
                    "output_directory": tmpdir_job0,
                    "num_partitions": 1,
                },
                {
                    "destination": ("localhost", 3001),
                },
            ),
            (
                {
                    "message_type": "new_map_task",
                    "task_id": 1,
                    "executable": str(TESTDATA_DIR/"exec/wc_map.sh"),
                    "input_paths": [
                        str(TESTDATA_DIR/"input/file02"),
                        str(TESTDATA_DIR/"input/file04"),
                        str(TESTDATA_DIR/"input/file06"),
                        str(TESTDATA_DIR/"input/file08"),
                    ],
                    "output_directory": tmpdir_job0,
                    "num_partitions": 1,
                },
                {
                    "destination": ("localhost", 3001),
                },
            ),
            (
                {
                    "message_type": "new_reduce_task",
                    "task_id": 0,
                    "executable": str(TESTDATA_DIR/"exec/wc_reduce.sh"),
                    "input_paths": [
                        f"{tmpdir_job0}/maptask00000-part00000",
                        f"{tmpdir_job0}/maptask00001-part00000"
                    ],
                    "output_directory": str(tmp_path),
                },
                {
                    "destination": ("localhost", 3001),
                },
            ),
            (
                {
                    "message_type": "shutdown",
                },
                {
                    "destination": ("localhost", 3001),
                },
            )
        ]
E       AssertionError: assert [({'message_type': 'register_ack'}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_map_task', 'task_id': 0, 'input_paths': ['/Users/led/Documents/EECS485p4/tests/testdata/input/file01', '/Users/led/Documents/EECS485p4/tests/testdata/input/file03', '/Users/led/Documents/EECS485p4/tests/testdata/input/file05', '/Users/led/Documents/EECS485p4/tests/testdata/input/file07'], 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh', 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec', 'num_partitions': 1}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_map_task', 'task_id': 1, 'input_paths': ['/Users/led/Documents/EECS485p4/tests/testdata/input/file02', '/Users/led/Documents/EECS485p4/tests/testdata/input/file04', '/Users/led/Documents/EECS485p4/tests/testdata/input/file06', '/Users/led/Documents/EECS485p4/tests/testdata/input/file08'], 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh', 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec', 'num_partitions': 1}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_reduce_task', 'task_id': 0, 'input_paths': ['/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000', '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00000-part00000'], 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_reduce.sh', 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0'}, {'destination': ('localhost', 3001)}), ({'message_type': 'shutdown'}, {'destination': ('localhost', 3001)})] == [({'message_type': 'register_ack'}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_map_task', 'task_id': 0, 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh', 'input_paths': ['/Users/led/Documents/EECS485p4/tests/testdata/input/file01', '/Users/led/Documents/EECS485p4/tests/testdata/input/file03', '/Users/led/Documents/EECS485p4/tests/testdata/input/file05', '/Users/led/Documents/EECS485p4/tests/testdata/input/file07'], 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec', 'num_partitions': 1}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_map_task', 'task_id': 1, 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh', 'input_paths': ['/Users/led/Documents/EECS485p4/tests/testdata/input/file02', '/Users/led/Documents/EECS485p4/tests/testdata/input/file04', '/Users/led/Documents/EECS485p4/tests/testdata/input/file06', '/Users/led/Documents/EECS485p4/tests/testdata/input/file08'], 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec', 'num_partitions': 1}, {'destination': ('localhost', 3001)}), ({'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00000-part00000', '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000'], 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0'}, {'destination': ('localhost', 3001)}), ({'message_type': 'shutdown'}, {'destination': ('localhost', 3001)})]
E         
E         At index 3 diff: ({'message_type': 'new_reduce_task', 'task_id': 0, 'input_paths': ['/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000', '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00000-part00000'], 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_reduce.sh', 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0'}, {'destination': ('localhost', 3001)}) != ({'message_type': 'new_reduce_task', 'task_id': 0, 'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_reduce.sh', 'input_paths': ['/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00000-part00000', '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000'], 'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0'}, {'destination': ('localhost', 3001)})
E         
E         Full diff:
E           [
E               (
E                   {
E                       'message_type': 'register_ack',
E                   },
E                   {
E                       'destination': (
E                           'localhost',
E                           3001,
E                       ),
E                   },
E               ),
E               (
E                   {
E                       'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh',
E                       'input_paths': [
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file01',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file03',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file05',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file07',
E                       ],
E                       'message_type': 'new_map_task',
E                       'num_partitions': 1,
E                       'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec',
E                       'task_id': 0,
E                   },
E                   {
E                       'destination': (
E                           'localhost',
E                           3001,
E                       ),
E                   },
E               ),
E               (
E                   {
E                       'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_map.sh',
E                       'input_paths': [
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file02',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file04',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file06',
E                           '/Users/led/Documents/EECS485p4/tests/testdata/input/file08',
E                       ],
E                       'message_type': 'new_map_task',
E                       'num_partitions': 1,
E                       'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec',
E                       'task_id': 1,
E                   },
E                   {
E                       'destination': (
E                           'localhost',
E                           3001,
E                       ),
E                   },
E               ),
E               (
E                   {
E                       'executable': '/Users/led/Documents/EECS485p4/tests/testdata/exec/wc_reduce.sh',
E                       'input_paths': [
E         +                 '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000',
E                           '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00000-part00000',
E         -                 '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec/maptask00001-part00000',
E                       ],
E                       'message_type': 'new_reduce_task',
E                       'output_directory': '/private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0',
E                       'task_id': 0,
E                   },
E                   {
E                       'destination': (
E                           'localhost',
E                           3001,
E                       ),
E                   },
E               ),
E               (
E                   {
E                       'message_type': 'shutdown',
E                   },
E                   {
E                       'destination': (
E                           'localhost',
E                           3001,
E                       ),
E                   },
E               ),
E           ]

tests/test_manager_03.py:174: AssertionError
------------------------------ Captured log call -------------------------------
INFO     mapreduce.manager.__main__:__main__.py:26 Manager init: host=localhost port=6000 pwd=/Users/led/Documents/EECS485p4
INFO     mapreduce.manager.__main__:__main__.py:61 manager setup TCP
INFO     mapreduce.manager.__main__:__main__.py:391 Manager setup UDP
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type register
INFO     mapreduce.manager.__main__:__main__.py:137 register worker ('localhost', 3001)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type new_manager_job
INFO     mapreduce.manager.__main__:__main__.py:164 creating a new job 0
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:244 starting to run a job: 0
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:254 Created tmpdir /private/var/folders/fj/_yv_cx216ng57tdvll1385y40000gn/T/pytest-of-led/pytest-42/test_finish0/mapreduce-shared-job00000-86fm0lec
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 0 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 1 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:310 ----------fddd----------
INFO     mapreduce.manager.__main__:__main__.py:327 manager going to assign reduce task 0, with 2 input files
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type finished
INFO     mapreduce.manager.__main__:__main__.py:196 mark job 0 task 0 as finished
INFO     mapreduce.manager.__main__:__main__.py:72 ('127.0.0.1', 10000)
INFO     mapreduce.manager.__main__:__main__.py:84 manager receive message, type shutdown
INFO     mapreduce.manager.__main__:__main__.py:113 call shutdown on manager, now there is 1 workers
INFO     mapreduce.manager.__main__:__main__.py:413 worker 3001 receices heartbeat
=========================== short test summary info ============================
FAILED tests/test_manager_03.py::test_finish - AssertionError: assert [({'mes...
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
============================== 1 failed in 4.04s ===============================
